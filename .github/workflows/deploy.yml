name: Deploy web application

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Create environment file
              run: |
                  echo "GITHUB_TOKEN=${{ secrets.GH_GRAPHQL_TOKEN }}" > .env

            - name: Build the application
              run: npm run build

            - name: Prepare SSH environment
              env:
                SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                SSH_HOST: ${{ secrets.SSH_HOST }}
                SSH_PORT: ${{ secrets.SSH_PORT }}
              run: |
                # SSH-Verzeichnis und SchlÃ¼ssel sicher einrichten
                mkdir -p ~/.ssh
                echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                chmod 600 ~/.ssh/id_rsa
                echo "Host deployment-target
                  HostName $SSH_HOST
                  User ${{ secrets.SSH_USER }}
                  Port $SSH_PORT
                  StrictHostKeyChecking no
                  IdentityFile ~/.ssh/id_rsa" > ~/.ssh/config

            - name: Test SSH connection
              run: ssh deployment-target "echo 'SSH connection successful'"

            - name: Deploy to VPS with rsync
              run: |
                rsync -avz --delete \
                  --exclude="node_modules" \
                  --exclude=".git" \
                  --exclude=".github" \
                  --exclude=".env*" \
                  ./ deployment-target:/home/Apps/Webapps/LeshMe/

            - name: Detect Node.js and PM2 paths
              id: detect_paths
              run: |
                echo "Suche nach Node.js und PM2 auf dem Server..."
                
                # npm-Pfad ermitteln
                NPM_PATH=$(ssh deployment-target "find ~/.nvm -path \"*/bin/npm\" | head -n 1")
                if [ -z "$NPM_PATH" ]; then
                  echo "WARNUNG: Konnte npm nicht finden"
                  NPM_PATH="npm"  # Fallback
                fi
                echo "npm_path=$NPM_PATH" >> $GITHUB_OUTPUT
                
                # PM2-Pfad ermitteln
                PM2_PATH=$(ssh deployment-target "find ~/.nvm -path \"*/bin/pm2\" | head -n 1")
                if [ -z "$PM2_PATH" ]; then
                  echo "PM2 nicht gefunden, versuche Installation..."
                  ssh deployment-target "export NVM_DIR=\"\$HOME/.nvm\" && . \"\$NVM_DIR/nvm.sh\" && npm install -g pm2"
                  PM2_PATH=$(ssh deployment-target "find ~/.nvm -path \"*/bin/pm2\" | head -n 1")
                  
                  if [ -z "$PM2_PATH" ]; then
                    echo "WARNUNG: PM2 konnte nicht gefunden oder installiert werden"
                    PM2_PATH="pm2"  # Fallback
                  fi
                fi
                echo "pm2_path=$PM2_PATH" >> $GITHUB_OUTPUT
                
                echo "Pfade ermittelt: npm=$NPM_PATH, pm2=$PM2_PATH"

            - name: Setup application on server
              run: |
                ssh deployment-target << EOF
                  cd /home/Apps/Webapps/LeshMe
                  ${{ steps.detect_paths.outputs.npm_path }} ci --production
                  
                  if ${{ steps.detect_paths.outputs.pm2_path }} list | grep -q "LeshMe"; then
                    echo "Prozess existiert - wird neugestartet"
                    ${{ steps.detect_paths.outputs.pm2_path }} reload LeshMe || ${{ steps.detect_paths.outputs.pm2_path }} restart LeshMe
                  else
                    echo "Prozess existiert nicht - wird neu erstellt"
                    ${{ steps.detect_paths.outputs.pm2_path }} start npm --name "LeshMe" -- start
                  fi
                  
                  ${{ steps.detect_paths.outputs.pm2_path }} save
                EOF

            - name: Verify deployment
              run: |
                echo "Verifiziere Deployment..."
                ssh deployment-target "${{ steps.detect_paths.outputs.pm2_path }} status LeshMe"

            - name: Deployment notification
              if: always()
              run: |
                if [ ${{ job.status }} == "success" ]; then
                  echo "Deployment erfolgreich abgeschlossen"
                else
                  echo "Deployment fehlgeschlagen"
                fi
